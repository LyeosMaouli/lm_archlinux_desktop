# Custom Fail2ban Jails Configuration
# Generated by Arch Linux Desktop Automation
# Date: {{ ansible_date_time.iso8601 }}

[DEFAULT]
# Ban time for 24 hours
bantime = 86400
# Find time window of 10 minutes
findtime = 600
# Maximum 3 attempts before ban
maxretry = 3

# SSH Jail (custom configuration)
[sshd-custom]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = {{ fail2ban_ssh_maxretry | default(3) }}
bantime = {{ fail2ban_ssh_bantime | default(86400) }}
findtime = {{ fail2ban_ssh_findtime | default(600) }}

# HTTP/HTTPS flood protection
[http-get-dos]
enabled = {{ fail2ban_http_dos_enabled | default('false') }}
port = http,https
filter = http-get-dos
logpath = /var/log/nginx/access.log
maxretry = 400
findtime = 400
bantime = 600
action = iptables[name=HTTP, port=http, protocol=tcp]

# Nginx specific protections
[nginx-http-auth]
enabled = {{ fail2ban_nginx_auth_enabled | default('false') }}
port = http,https
filter = nginx-http-auth
logpath = /var/log/nginx/error.log
maxretry = 6

[nginx-noscript]
enabled = {{ fail2ban_nginx_noscript_enabled | default('false') }}
port = http,https
filter = nginx-noscript
logpath = /var/log/nginx/access.log
maxretry = 6

[nginx-badbots]
enabled = {{ fail2ban_nginx_badbots_enabled | default('false') }}
port = http,https
filter = nginx-badbots
logpath = /var/log/nginx/access.log
maxretry = 2

# Postfix mail server protection
[postfix-sasl]
enabled = {{ fail2ban_postfix_enabled | default('false') }}
port = smtp,465,submission
filter = postfix-sasl
logpath = /var/log/mail.log
maxretry = 3

# VSFTPD protection
[vsftpd]
enabled = {{ fail2ban_vsftpd_enabled | default('false') }}
port = ftp,ftp-data,ftps,ftps-data
filter = vsftpd
logpath = /var/log/vsftpd.log
maxretry = 6

# Apache specific protections
[apache-auth]
enabled = {{ fail2ban_apache_auth_enabled | default('false') }}
port = http,https
filter = apache-auth
logpath = /var/log/apache*/*error.log
maxretry = 6

[apache-badbots]
enabled = {{ fail2ban_apache_badbots_enabled | default('false') }}
port = http,https
filter = apache-badbots
logpath = /var/log/apache*/*access.log
maxretry = 2

[apache-noscript]
enabled = {{ fail2ban_apache_noscript_enabled | default('false') }}
port = http,https
filter = apache-noscript
logpath = /var/log/apache*/*access.log
maxretry = 6

[apache-overflows]
enabled = {{ fail2ban_apache_overflows_enabled | default('false') }}
port = http,https
filter = apache-overflows
logpath = /var/log/apache*/*error.log
maxretry = 2

# Systemd journal based jails
[systemd-ssh]
enabled = {{ fail2ban_systemd_ssh_enabled | default('true') }}
filter = systemd-ssh
backend = systemd
maxretry = {{ fail2ban_ssh_maxretry | default(3) }}
bantime = {{ fail2ban_ssh_bantime | default(86400) }}
findtime = {{ fail2ban_ssh_findtime | default(600) }}

# Custom recidive jail for repeat offenders
[recidive]
enabled = {{ fail2ban_recidive_enabled | default('true') }}
filter = recidive
logpath = /var/log/fail2ban.log
action = iptables-allports[name=recidive,protocol=all]
         sendmail-whois-lines[name=recidive, logpath=/var/log/fail2ban.log]
bantime = {{ fail2ban_recidive_bantime | default(604800) }}  # 1 week
findtime = {{ fail2ban_recidive_findtime | default(86400) }}  # 1 day
maxretry = {{ fail2ban_recidive_maxretry | default(5) }}

# Custom action for notification
[DEFAULT]
{% if fail2ban_email_enabled | default(false) %}
action = %(action_mwl)s
mta = sendmail
destemail = {{ fail2ban_email | default('root@localhost') }}
sender = {{ fail2ban_sender | default('fail2ban@localhost') }}
{% else %}
action = %(action_)s
{% endif %}