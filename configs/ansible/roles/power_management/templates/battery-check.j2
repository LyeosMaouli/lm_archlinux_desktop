#!/bin/bash
# Battery check script
# Generated by Ansible for {{ ansible_hostname }}

# Battery warning thresholds
CRITICAL_LEVEL={{ battery_critical_level | default(10) }}
LOW_LEVEL={{ battery_low_level | default(20) }}
WARNING_LEVEL={{ battery_warning_level | default(30) }}

# Get battery information
get_battery_info() {
    if [[ -f /sys/class/power_supply/BAT0/capacity ]]; then
        BATTERY_LEVEL=$(cat /sys/class/power_supply/BAT0/capacity)
        BATTERY_STATUS=$(cat /sys/class/power_supply/BAT0/status)
    elif command -v acpi >/dev/null 2>&1; then
        BATTERY_INFO=$(acpi -b | head -1)
        BATTERY_LEVEL=$(echo "$BATTERY_INFO" | grep -oE '[0-9]+%' | tr -d '%')
        BATTERY_STATUS=$(echo "$BATTERY_INFO" | awk '{print $3}' | tr -d ',')
    else
        echo "Unable to detect battery"
        exit 1
    fi
}

# Send notification
send_notification() {
    local level="$1"
    local message="$2"
    local urgency="$3"
    
    if command -v notify-send >/dev/null 2>&1; then
        notify-send -u "$urgency" "Battery $level%" "$message"
    fi
    
    # Log the event
    logger "Battery check: $level% - $message"
}

# Check battery level and send notifications
check_battery() {
    get_battery_info
    
    if [[ "$BATTERY_STATUS" == "Discharging" ]]; then
        if [[ $BATTERY_LEVEL -le $CRITICAL_LEVEL ]]; then
            send_notification "$BATTERY_LEVEL" "Critical battery level! System will hibernate soon." "critical"
            # Auto-hibernate if critically low
            {% if battery_auto_hibernate | default(true) %}
            if [[ $BATTERY_LEVEL -le {{ battery_auto_hibernate_level | default(5) }} ]]; then
                systemctl hibernate
            fi
            {% endif %}
        elif [[ $BATTERY_LEVEL -le $LOW_LEVEL ]]; then
            send_notification "$BATTERY_LEVEL" "Low battery level. Please connect charger." "normal"
        elif [[ $BATTERY_LEVEL -le $WARNING_LEVEL ]]; then
            send_notification "$BATTERY_LEVEL" "Battery level is getting low." "low"
        fi
    fi
}

# Main execution
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    check_battery
fi