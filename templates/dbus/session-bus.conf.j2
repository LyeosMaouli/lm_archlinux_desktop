<!-- D-Bus Session Bus Configuration -->
<!-- Generated by Arch Linux Desktop Automation -->
<!-- Date: {{ ansible_date_time.iso8601 }} -->

<!DOCTYPE busconfig PUBLIC "-//freedesktop//DTD D-Bus Bus Configuration 1.0//EN"
 "http://www.freedesktop.org/standards/dbus/1.0/busconfig.dtd">
<busconfig>
  <!-- Session bus configuration -->
  <type>session</type>

  <!-- Listen on a debug pipe, if directed to do so -->
  <listen>unix:tmpdir={{ dbus_session_tmpdir | default('/tmp') }}</listen>

  <!-- Security policies -->
  <policy context="default">
    <!-- Allow everything to be sent -->
    <allow send_destination="*" eavesdrop="true"/>
    <!-- Allow everything to be received -->
    <allow eavesdrop="true"/>
    <!-- Allow anyone to own anything -->
    <allow own="*"/>
  </policy>

  <!-- Allow all users to connect -->
  <policy user="*">
    <allow own="*"/>
    <allow send_type="method_call"/>
    <allow send_type="signal"/>
    <allow send_type="method_return"/>
    <allow send_type="error"/>
    <allow receive_type="method_call"/>
    <allow receive_type="signal"/>
    <allow receive_type="method_return"/>
    <allow receive_type="error"/>
  </policy>

  <!-- Hyprland-specific services -->
  <policy user="{{ user_name | default('user') }}">
    <allow own="org.hyprland.*"/>
    <allow send_destination="org.hyprland.*"/>
    <allow receive_sender="org.hyprland.*"/>
  </policy>

  <!-- Desktop portal services -->
  <policy context="default">
    <allow own="org.freedesktop.portal.*"/>
    <allow send_destination="org.freedesktop.portal.*"/>
    <allow receive_sender="org.freedesktop.portal.*"/>
  </policy>

  <!-- Audio services (PipeWire) -->
  <policy context="default">
    <allow own="org.pipewire.*"/>
    <allow send_destination="org.pipewire.*"/>
    <allow receive_sender="org.pipewire.*"/>
    
    <allow own="org.freedesktop.ReserveDevice1.*"/>
    <allow send_destination="org.freedesktop.ReserveDevice1.*"/>
    <allow receive_sender="org.freedesktop.ReserveDevice1.*"/>
  </policy>

  <!-- Notification services -->
  <policy context="default">
    <allow own="org.freedesktop.Notifications"/>
    <allow send_destination="org.freedesktop.Notifications"/>
    <allow receive_sender="org.freedesktop.Notifications"/>
  </policy>

  <!-- Additional service configurations -->
  {% if dbus_additional_services is defined %}
  {% for service in dbus_additional_services %}
  <policy context="default">
    <allow own="{{ service.name }}"/>
    <allow send_destination="{{ service.name }}"/>
    <allow receive_sender="{{ service.name }}"/>
  </policy>
  {% endfor %}
  {% endif %}

  <!-- Limit message size and number of replies -->
  <limit name="max_incoming_bytes">1000000000</limit>
  <limit name="max_outgoing_bytes">1000000000</limit>
  <limit name="max_message_size">1000000000</limit>
  <limit name="service_start_timeout">120000</limit>
  <limit name="auth_timeout">240000</limit>
  <limit name="max_completed_connections">2048</limit>
  <limit name="max_incomplete_connections">64</limit>
  <limit name="max_connections_per_user">256</limit>
  <limit name="max_pending_service_starts">10</limit>
  <limit name="max_names_per_connection">50000</limit>
  <limit name="max_match_rules_per_connection">50000</limit>
  <limit name="max_replies_per_connection">50000</limit>
  <limit name="reply_timeout">300000</limit>

</busconfig>